<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Zoom and anti-aliasing | Canvas pixel manipulation</title>
</head>

<body>
  <table>
    <thead>
      <tr>
        <th>source</th>
        <th>zoomed pixels</th>
        <th>result</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <canvas id="canvas" width="300" height="227"></canvas>
        </td>
        <td align="center">
          <canvas id="pixelated-zoom" width="200" height="200"></canvas>
        </td>
        <td align="center">
          <canvas id="result" width="200" height="200"></canvas>
        </td>
      </tr>
    </tbody>
    <table>
      <script type="text/javascript">
        'use strict';
        (function () {

          // main canvas
          var canvas = document.getElementById('canvas');
          var ctx = canvas.getContext('2d');

          // zoomed canvas
          var pixelatedZoomCtx = document.getElementById('pixelated-zoom').getContext('2d');
          pixelatedZoomCtx.imageSmoothingEnabled = false;
          pixelatedZoomCtx.mozImageSmoothingEnabled = false;
          pixelatedZoomCtx.webkitImageSmoothingEnabled = false;
          pixelatedZoomCtx.msImageSmoothingEnabled = false;

          // result canvas
          const resultCanavs = document.getElementById('result');
          const resultCtx = resultCanavs.getContext('2d');

          // orignal image data (buffer), used to query pixel value
          let imageData0 = undefined;
          let curImageData = undefined;

          // load image(will be through file loading)
          var img = new Image();
          img.crossOrigin = 'anonymous';
          img.src = 'test.jpeg';
          img.onload = function () {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            console.log(`w = ${img.width} h = ${img.height}`);
            imageData0 = ctx.getImageData(0, 0, img.width, img.height);
            console.log(imageData0);
          };

          // The Uint8ClampedArray contains height × width × 4 bytes of data, with index values ranging from 0 to (height×width×4)-1.
          const getPixelValue = function (img, x, y) {
            if (x < 0 || y < 0 || x >= img.width || y >= img.height) console.error(`getPixelValue out of range!`);
            const index = 4 * (y * img.width + x);
            return [img.data[index + 0], img.data[index + 1], img.data[index + 2], img.data[index + 3]];
          }

          var drawEyeDroper = function (ctx, x, y) {
            const r = 4;
            const w = r * 2 + 1;
            ctx.drawImage(canvas,
              Math.min(Math.max(0, x - r), img.width - w),
              Math.min(Math.max(0, y - r), img.height - w),
              w, w,
              0, 0,
              200, 200);
          };

          let isFlooding = false;
          let thresh = undefined;

          // when mouse down, thresh is set
          canvas.addEventListener('mousedown', function (event) {
            thresh =
              isFlooding = true;
          });

          canvas.addEventListener('mouseup', function (event) {
            isFlooding = false;
          });

          canvas.addEventListener('mousemove', function (event) {
            const x = event.layerX;
            const y = event.layerY;
            drawEyeDroper(pixelatedZoomCtx, x, y);

            // show the selected pixel
            const color = getPixelValue(imageData0, x, y);
            const rgba = `rgba(${color[0]}, ${color[1]}, ${color[2]}, ${color[3] / 255})`;
            resultCanavs.style.background = rgba;

          });


        })()
      </script>
</body>

</html>