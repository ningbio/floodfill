<!DOCTYPE html>
<html>
<header>
    <title>ONNX Runtime JavaScript examples: Quick Start - Web (using script tag)</title>
    <input id="image-selector" type="file" style="top:10px;left:10px">
    <button id="predict-button" class="btn btn-dark float-right" style="top:10px;left:70px">Predict</button>
    <img id="selected-image" src="" />
    <canvas id="canvas" width=320px height=320px></canvas>
</header>

<body>
    <!-- import ONNXRuntime Web from CDN -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script>
        $("#image-selector").change(function () {
            let reader = new FileReader();
            reader.onload = function () {
                let dataURL = reader.result;
                $("#selected-image").attr("src", dataURL);
            }
            let file = $("#image-selector").prop("files")[0];
            reader.readAsDataURL(file);
        });

        // async function main() {
        $("#predict-button").click(async function () {
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");


            const session = await ort.InferenceSession.create('./u2netp.onnx').then(console.log("model loaded"));
            // input_name = getInputs();
            const u2width = 320;
            const inputNames = session.inputNames;
            const outputNames = session.outputNames;
            let image = $("#selected-image").get(0);
            var oc = document.createElement('canvas'),
                octx = oc.getContext('2d');
            oc.width = u2width;
            oc.height = u2width;
            octx.drawImage(image, 0, 0, oc.width, oc.height);
            var input_imageData = octx.getImageData(0, 0, u2width, u2width);
            console.log("input_imageData", input_imageData.data)

            // data has to be r-plane, g-plane, b-plane and necessary image normalization (x-mean)/std, (mean,std) is from imagenet
            var imagePlanes = new Float32Array(u2width * u2width * 3);
            const planeSize = u2width * u2width;
            const mean = [0.485, 0.456, 0.406];
            const std = [0.229, 0.224, 0.225];
            for (let i = 0; i < u2width; i++) {
                for (let j = 0; j < u2width; j++) {
                    const idx = i * u2width + j;
                    for (let k = 0; k < 3; k++) {
                        imagePlanes[k * planeSize + idx] = (input_imageData.data[4 * idx + k] / 255.0 - mean[k]) / std[k];//floatArr[3 * idx + k];
                    }
                }
            }

            const input = new ort.Tensor('float32', imagePlanes, [1, 3, 320, 320])
            a = inputNames[0]
            const feeds = { "input.1": input };
            const results = await session.run(feeds).then();
            const pred = Object.values(results)[0]
            var myImageData = ctx.createImageData(320, 320);
            for (let i = 0; i < pred.data.length * 4; i += 4) {
                var pixelIndex = i;
                if (i != 0) {
                    t = i / 4;
                }
                else {
                    t = 0;
                }
                myImageData.data[pixelIndex] = Math.round(pred.data[t] * 255);  // red   color
                myImageData.data[pixelIndex + 1] = Math.round(pred.data[t] * 255);  // green color
                myImageData.data[pixelIndex + 2] = Math.round(pred.data[t] * 255);  // blue  color
                myImageData.data[pixelIndex + 3] = 255;
            }
            ctx.putImageData(myImageData, 0, 0);
        });
    </script>
</body>

</html>